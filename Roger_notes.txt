# debian version : debian-9.8.0-amd64-netinst

# Params VirtualBox
File -> Host Network manager -> Create + No DHCP

# Params VM on VirtualBox
-- New -> Linux/Debian 64-bit
	1024mb RAM
	Virtual Hard Disk
	VB Disk Image - Dinamically allocated - 8.00GB
-- Settings -> Network -> Adapter 2 -> Enable -> Host-only Adapter

# Install VM
-- Start Install
	Name : Roger
	Domaine : 42.fr
	mdp su : niconico
	Nouvel utilisateur / nom complet : nicolasvienot - ID : nvienot
	mdp : nico
-- Partitionner les disques
	Manuel
	SCSI1
	Nouvelle Partition Primaire 4.501GB -> / (ext4) attention df -h ->4.1 fdisk -l OK
	Deuxieme Partition Primaire 1GB (swap)
	Troisieme Partition Primaire reste -> /home (ext4)
-- Config
	Miroir de l'archive Debian -> France -> ftp.fr.debian.org
	Mandataire HTTP -> Empty
	Logiciels : SSH + utilitaires usuels
	Programme de demarrage GRsuUB? - OUI - /dev/sda
	OK

# In VM Debian
# Start

apt install -y vim sudo net-tools iptables-persistent fail2ban sendmail apache2

Regles engistrer iptales persistent? NOOOOOOOO fait a tester

# SSH
-- vim /etc/ssh/sshd_config
	Port -> 2222 
	Décommente -> PasswordAuthentification yes
	Décommenter -> PermitRootLogin prohibit-password et mettre no
	Décommenter -> PubkeyAuthentication yes
-- vim /etc/network/interfaces
	Ajouter :
	allow-hotplug enp0s8
	iface enp0s8 inet static
	address 192.168.56.3
	netmask 255.255.255.252
-- Add user avec droitnicos sudossh n
	adduser username
	adduser username sudo
	reboot
-- Dans terminal Host
	ssh-keygen
	enregistrer key publique
	cat ~/.ssh/id_rsa.pub
	keygen nico : ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDK7/lcyWSGiLGbOtzkkzx2WvvmFlRlAqWvzjkP02KpEscB2tpKhEyoKRQh9Pq2Gtph8oCiUSk4yxk/SRbYlRvXZSyR94BcZyMmJPOkEYh8nw62epTML13fZ153TPHnUOPKXSW63XwIf9pya+4ldpXIeSnlgUu09eKeEQrqiAllAVtb6OomsGZSFRnQ4lOe1V8VBu/iJTCJvWQ1/51sclZudcRh22npG0G4opsTlaGlamJ+G7RZqdUqtzZs50X3vapDLClbgp/lScsaMsyEMWUMfIBKIEG0V5ShFHlBwayC5//cDs4Ae3/uxMNWHzsGfwRCVb/vWpIXcT8Tf/KHKUw3 nvienot@e1r3p14.42.fr
	nico2 : ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDCD65OtBIYbHudKa0hsDJgEgSDjrjI+ivR1QP64K2cvdgWeYQyqNNHfF/omRTxIEIlwWOwZvKTiM7MV1KH7/HDikxxQ6itM+JQ5c5X0XNb4RDiXPS/+Xg0YweuECU+XsIUCGcM5BRiXc27AK/6vhO5fKC0wJt3S+Th+oO36Xqqka4+9Lh/p/Xc+nIiKRYJYvVjz8f0R3OyK1VmGgElN11IYUncmYaLPZ+rfbitAKiJfrRVuYdvRTv5er3/N+o1AUIOo6TREuVCxWHVJjW/j3LZNZo/a+1/IK9PCtsK3ieBQcWWxWSsjaB9tzsr1RyKoIDAxj1Eda43NCeq1rgbzGPr nvienot@e1r3p13.42.fr
			ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDCD65OtBIYbHudKa0hsDJgEgSDjrjI+ivR1QP64K2cvdgWeYQyqNNHfF/omRTxIEIlwWOwZvKTiM7MV1KH7/HDikxxQ6itM+JQ5c5X0XNb4RDiXPS/+Xg0YweuECU+XsIUCGcM5BRiXc27AK/6vhO5fKC0wJt3S+Th+oO36Xqqka4+9Lh/p/Xc+nIiKRYJYvVjz8f0R3OyK1VmGgElN11IYUncmYaLPZ+rfbitAKiJfrRVuYdvRTv5er3/N+o1AUIOo6TREuVCxWHVJjW/j3LZNZo/a+1/IK9PCtsK3ieBQcWWxWSsjaB9tzsr1RyKoIDAxj1Eda43NCeq1rgbzGPr nvienot@e1r3p13.42.fr
-- ssh nico@192.168.56.1 -p 2222
	.ssh/authorized_keys -> key
	sudo vim /etc/ssh/sshd_config -> PasswordAuthentification to no
	sudo service ssh restart
	exit

# FIREWALL
https://www.commentcamarche.net/forum/affich-1943263-ajouter-un-interface-reseau-eth1
-- sudo iptables -L
-- sudo vim /etc/network/if-pre-up.d/iptables
	#!/bin/bash
	iptables-restore < /etc/iptables.test.rules
	iptables -F
	iptables -X
	iptables -t nat -F
	iptables -t nat -X
	iptables -t mangle -F
	iptables -t mangle -X
	iptables -P INPUT DROP
	iptables -P OUTPUT DROP
	iptables -P FORWARD DROP
	iptables -A INPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
	iptables -A INPUT -p tcp -i enp0s8 --dport 2222 -j ACCEPT
	iptables -A INPUT -p tcp -i enp0s8 --dport 80 -j ACCEPT
	iptables -A INPUT -p tcp -i enp0s8 --dport 443 -j ACCEPT
	iptables -A OUTPUT -m conntrack ! --ctstate INVALID -j ACCEPT
	iptables -I INPUT -i lo -j ACCEPT
	iptables -A INPUT -j LOG
	iptables -A FORWARD -j LOG
	iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above 10 --connlimit-mask 20 -j DROP
	exit 0
-- sudo chmod +x /etc/network/if-pre-up.d/iptables

# DOS


Mail -> postfix et non sendmail
https://www.digitalocean.com/community/tutorials/how-to-install-and-configure-postfix-as-a-send-only-smtp-server-on-debian-9


Bonjour bonjour,
Sur RS-1, une phrase du sujet que je trouve très ambigüe : "Vous devez mettre en place des règles de pare-feu (firewall) sur le serveur avec uniquement les services utilisés accessible en dehors de la VM."
Concrètement ça veut dire quoi ? Je doit fermer tous les ports sauf ceux que j'utilise ? (ssh, http, https) ?

OUI


Yop, je vois BEAUCOUP de gens qui ont les scan de port pétés sur RS1 (facilement 80% en correction), je me permet de donner quelques astuces pour les protéger (il y a certainement mieux/différent, mais si ça peut donner quelques pistes pour ceux qui galèrent dessus)
- Pensez a les tester avant de push votre roger (avec nmap par exemple, faites aussi attention à ne pas vous être mis vous même en exception pour éviter de fausser les resultats, n'hésitez pas a tester Slowloris pour les DOS par la même occasion, même si beaucoup ont la flemme en correction), vous pouvez le faire soit à partir d'une autre VM, soit directement dans votre VM (en pensant bien à vous retirer des exceptions bien sur)
- Pas mal d'apps disponibles via apt marchent très bien pour les scans de port (Portsentry par exemple), c'est toujours bien plus pratique que de faire de la magie noire dans iptables imo
- Si en testant avec nmap vous voyez vos ports ouverts (ou fermés si vous en forcez un en particuler) sous la forme "HTTPS 443 open HTTP 80 open", non, c'est pas normal (même si vous êtes ban après), le scan de port à reussi et donc soit ils ne sont pas protégés, soit votre IP est en exception (portsentry.ignore pour Portsentry) et vous pouvez donc la retirer le temps de vos tests
- Si nmap timeout/affiche les ports en "filtered" (et donc n'arrive pas a déterminer si le port est ouvert ou non) ou vous ban directement sans vous indiquer les ports, c'est niquel


correction

fdisk -l -- partitions
dpks -l -- test packages?





restart
-- apt-get update
-- apt-get upgrade
-- apt install -y vim sudo net-tools iptables-persistent fail2ban sendmail apache2
-- vim /etc/ssh/sshd_config
-- vim /etc/network/interfaces
-- adduser nico
-- adduser nico sudo
-- reboot
ITERM Host
-- ssh-keygen
-- cat ~/.ssh/id_rsa.pub
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDSHn91PVV2nUbtUSqjAm78B6W4XdUURMCylg5xHH2fKoWX4gxY8jvMLUNSndcA5cINkjQW8x8Qg2LM9LRXphf2xEA+FGi5jFGaosSSRUXFMlWCXDBt6V/M97uJXwHL1YO3pOoRgjNoGY1oM3WfZevI0vy+ftA42oYMO/isJE3CYDpFtS1COQ3jaO32UjKXT4nlxm0UF/K33QMGpsaJLVjFhL1K3/a44/BTCsdYbArRNhpRXIhzlNzl0x5uT5o6TylSA3KG/EjPIFU04D8gdJqJa0XQ8MYrctdbz4JSeJFFvz4QtmvGOr7jdm40KjIgW3fpQuj+OAipP3/CJvyJ+6oT nvienot@e1r5p5.42.fr
ssh nico@192.168.56.3 -p 2222
yes
ITEM VM
mkdir .ssh
sudo vim .ssh/authorized_keys
sudo vim /etc/ssh/sshd_config
sudo service ssh restart
sudo iptables -L
sudo vim /etc/network/if-pre-up.d/iptables
sudo chmod +x /etc/network/if-pre-up.d/iptables
sudo touch /var/log/apache2/server.log
sudo vim /etc/fail2ban/jail.local
sudo vim /etc/fail2ban/filter.d/http-get-dos.conf
sudo systemctl restart fail2ban.service
sudo iptables -L
#Scan ports
sudo netstat -paunt
systemctl list-unit-files
systemctl disable <services inutiles>




Mail

sudo sendmailconfig
sudo service apache2 restart
sudo sendmail nvienot@student.42.fr < /home/nico/email.txt
echo "test message" | sudo sendmail -v nvienot@gmail.com

WORKING

------------------------------------------------------------------

jail

[DEFAULT]
destemail = nico@.42.fr
sender = root@roger-skyline.fr

[sshd]
port = 2222
enabled = true
maxretry = 5
findtime = 120
bantime = 60

[sshd-ddos]
port = 2222
enabled = true

[recidive]
enabled = true

[apache]
enabled = true
port = http, https
filter = apache-auth
logpath = /var/log/apache2*/*error.log
maxretry = 6
findtime = 600

[apache-noscript]
enabled = true

[apache-overflows]

enabled  = true
port     = http,https
filter   = apache-overflows
logpath  = /var/log/apache2*/*error.log
maxretry = 2

[apache-badbots]

enabled  = true
port     = http,https
filter   = apache-badbots
logpath  = /var/log/apache2*/*error.log
maxretry = 2

[http-get-dos]
enabled = true
port = http,https
filter = http-get-dos
logpath = /var/log/apache2/server.log
maxretry = 100
findtime = 300
bantime = 300
action = iptables[name=HTTP, port=http, protocol=tcp]

--------------------------------------------------------------

http-get-dos

[Definition]

# Option: failregex
# Note: This regex will match any GET entry in your logs, so basically all valid and not valid entries are a match.
# You should set up in the jail.conf file, the maxretry and findtime carefully in order to avoid false positives.

failregex = ^<HOST> -.*"(GET|POST).*

# Option: ignoreregex
# Notes.: regex to ignore. If this regex matches, the line is ignored.
# Values: TEXT
#
ignoreregex =

-------------------------------------------------------------

watch_script

#!/bin/bash
cat /etc/crontab > /home/nico/new
DIFF=$(diff new tmp)
if [ "$DIFF" != "" ]; then
	sudo sendmail nico@MAIL.com < /home/nico/email.txt
	rm -rf /home/nico/tmp
	cp /home/nico/new /home/nico/tmp
fi

-------------------------------------------------------------

crontab ??

# /etc/crontab: system-wide crontab
# Unlike any other crontab you don't have to run the `crontab'
# command to install the new version when you edit this file
# and files in /etc/cron.d. These files also have username fields,
# that none of the other crontabs do.

SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

# m h dom mon dow user	command
17 *	* * *	root    cd / && run-parts --report /etc/cron.hourly
25 6	* * *	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.daily )
47 6	* * 7	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.weekly )
52 6	1 * *	root	test -x /usr/sbin/anacron || ( cd / && run-parts --report /etc/cron.monthly )
0 4	* * 1	root	/home/USER/update_script.sh  >> /var/log/update_script.log
@reboot		root	/home/USER/update_script.sh  >> /var/log/update_script.log
0 0	* * *	root	/home/USER/watch_script.sh
#



















///

test fail2ban
/var/log/fail2ban/log
iptables -L


 Pour le scan de ports --> nmap
Pour le dos --> slowloris
Pour les services genre iptables pour le SSH -> à la main


perl slowloris.pl -dns <ip> -port <port a tester>
sudo tail -f /var/log/auth.log

ps aux | grep dhc test si dhcp la ou pas






// TEST BRIDGE

netstat -r getdefault

mettre gateway


---------------------------------------------------

apt-get update -y && apt-get upgrade -y

#apt-get install sudo vim ufw portsentry fail2ban apache2 mailutils -y
apt install -y vim sudo net-tools iptables-persistent fail2ban sendmail apache2

sudo service networking restart
ip addr ? ifconfig
sudo vim /etc/ssh/sshd_config
Port -> 55555
	Décommente -> PasswordAuthentification yes
	Décommenter -> PermitRootLogin prohibit-password et mettre no
	Décommenter -> PubkeyAuthentication yes
ssh-keygen -t rsa
id_rsa: Our private key, should be keep safely, She can be crypted with a password.
id_rsa.pub Our private key, you have to transfer this one to the server
ssh-copy-id -i id_rsa.pub gde@10.11.200.247 -p 50683
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDdpiXxAgJU5BuiMUmvmoZSB6Qah9E10abUjt9VVceEr6Sbcewhm1pyia8s14zsb6M1ZiieUpW1s8mF5beHSEDpV2avhp/dZ4sjqJbr1Z2vazH4JYEzgI5ZWAvE+XuCi52YaHB8xDWQunZYcC1Io3ageOEGIBH2wLJs202zN+xbYpSsIUZMuZXYXaf5Cuoaim63uh/QeVMCnetOzpgcSDI5LxAELEDHubKCm+GNPoJ6D+X49tpnR0fF2I3ej9r+sXu6l4LLRIhJ7hwwI/hLJI+RMATafqsWT+NPZCTt8QpIc4jpfbRU+JIv8z6cWV58yHI0BGpB+c/j+woyK4JjOApP nvienot@e1r5p3.42.fr
➜  SL git:(master) ✗ ssh nico@10.11.123.123 -p 55555
The authenticity of host '[10.11.123.123]:55555 ([10.11.123.123]:55555)' can't be established.
ECDSA key fingerprint is SHA256:QZd8Byy86183N9t2n+01G5b1IvVgL6lgspTMsGXsrZE.
Are you sure you want to continue connecting (yes/no)? yes
Warning: Permanently added '[10.11.123.123]:55555' (ECDSA) to the list of known hosts.
nico@10.11.123.123's password:
Linux roger 4.9.0-8-amd64 #1 SMP Debian 4.9.144-3.1 (2019-02-19) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Thu Mar 21 00:48:53 2019
nico@roger:~$ mkdir .ssh
nico@roger:~$ sudo vim .ssh/authorized_keys
[sudo] password for nico:
Sorry, try again.
[sudo] password for nico:

nico@roger:~$ sudo vim /etc/ssh/sshd_config
nico@roger:~$

sudo netstat -paunt











APACHE ATTENTION :
sudo systemctl reload apache2




DHCP?
-- 



 ss -tulnp PORTS AAAAB3NzaC1yc2EAAAADAQABAAABAQDCD65OtBIYbHudKa0hsDJgEgSDjrjI




 service --status-all



 https://fr-wiki.ikoula.com/fr/Se_prot%C3%A9ger_contre_le_scan_de_ports_avec_portsentry

 trouver ipbannies iptables -L -n -v

 check ban
 sudo iptables -S

 sudo tail -n 5 /var/log/syslog PORTSENTRY